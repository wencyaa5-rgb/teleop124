# 控制信号测试指南

## ✅ 控制信号已成功到达机器人

从日志确认：
- ✅ 前端正确发送到 `dataChannel`
- ✅ 机器人端数据通道已打开
- ✅ ROS节点已初始化

## 🎮 键盘控制映射

### 方向控制（Axes）

| 按键 | 功能 | Axes值 | ROS话题值 |
|------|------|--------|-----------|
| **↑ (上箭头)** | 前进 | `axes[1] = -0.6` | `axes[1] = 0.6` (反转后) |
| **↓ (下箭头)** | 后退 | `axes[1] = 0.6` | `axes[1] = -0.6` (反转后) |
| **→ (右箭头)** | 右转 | `axes[0] = 0.6` | `axes[0] = -0.6` (反转后) |
| **← (左箭头)** | 左转 | `axes[0] = -0.6` | `axes[0] = 0.6` (反转后) |

### 按钮控制（Buttons）

| 按键 | 功能 | Button索引 | 值 |
|------|------|------------|-----|
| **空格键 (Space)** | A按钮 (释放) | `buttons[0]` | `1` |
| **P键** | B按钮 (抓取) | `buttons[1]` | `1` |
| **X键** | X按钮 | `buttons[2]` | `1` |
| **Y键** | Y按钮 | `buttons[3]` | `1` |
| **]键 (右方括号)** | 右扳机 | `buttons[7]` | `0.15` |
| **[键 (左方括号)** | 左扳机 | `buttons[6]` | `0.4` |
| **H键** | Home按钮 | `buttons[16]` | `1` |

## 🎮 手柄控制映射（Xbox 360风格）

### 摇杆（Axes）

| 手柄输入 | 功能 | Axes索引 | 说明 |
|---------|------|----------|------|
| **左摇杆 X轴** | 左右移动 | `axes[0]` | -1.0 (左) 到 1.0 (右) |
| **左摇杆 Y轴** | 前后移动 | `axes[1]` | -1.0 (前) 到 1.0 (后) |
| **右摇杆 X轴** | 旋转 | `axes[2]` | -1.0 到 1.0 |
| **右摇杆 Y轴** | 俯仰 | `axes[3]` | -1.0 到 1.0 |
| **左扳机** | 左扳机 | `axes[4]` | 0.0 到 1.0 |
| **右扳机** | 右扳机 | `axes[5]` | 0.0 到 1.0 |
| **十字键左右** | 十字键水平 | `axes[6]` | -1.0 (左) 到 1.0 (右) |
| **十字键前后** | 十字键垂直 | `axes[7]` | -1.0 (前) 到 1.0 (后) |

### 按钮（Buttons）

| 手柄按钮 | 功能 | Button索引 | 说明 |
|---------|------|------------|------|
| **A按钮** | 释放 | `buttons[0]` | 0 或 1 |
| **B按钮** | 抓取 | `buttons[1]` | 0 或 1 |
| **X按钮** | X功能 | `buttons[2]` | 0 或 1 |
| **Y按钮** | Y功能 | `buttons[3]` | 0 或 1 |
| **LB (左肩)** | 左肩按钮 | `buttons[4]` | 0 或 1 |
| **RB (右肩)** | 右肩按钮 | `buttons[5]` | 0 或 1 |
| **Back** | 返回 | `buttons[8]` | 0 或 1 |
| **Start** | 开始 | `buttons[9]` | 0 或 1 |
| **左摇杆按下** | 左摇杆按钮 | `buttons[10]` | 0 或 1 |
| **右摇杆按下** | 右摇杆按钮 | `buttons[11]` | 0 或 1 |
| **Home/Power** | 回到初始位置 | `buttons[16]` | 0 或 1 |

## 🧪 测试步骤

### 1. 键盘测试

1. **确保连接建立**
   - 前端显示 "Data channel is open"
   - 机器人端显示 "✅ [DATA CHANNEL] Data channel is open"

2. **测试方向控制**
   - 按 **↑** 键 → 应该看到机器人前进
   - 按 **↓** 键 → 应该看到机器人后退
   - 按 **→** 键 → 应该看到机器人右转
   - 按 **←** 键 → 应该看到机器人左转

3. **测试按钮控制**
   - 按 **空格键** → 触发A按钮（释放）
   - 按 **P键** → 触发B按钮（抓取）
   - 按 **H键** → 触发Home按钮（回到初始位置）

### 2. 手柄测试

1. **连接手柄**
   - 将手柄连接到电脑
   - 浏览器会自动检测（查看console是否有 "Gamepad connected" 日志）

2. **测试摇杆**
   - 移动左摇杆 → 控制机器人移动
   - 移动右摇杆 → 控制机器人旋转/俯仰

3. **测试按钮**
   - 按A按钮 → 释放动作
   - 按B按钮 → 抓取动作
   - 按Home按钮 → 回到初始位置

### 3. ROS验证

在机器人端运行以下命令验证控制信号：

```bash
# 进入容器
docker exec -it teleop /bin/bash
source /opt/ros/humble/setup.bash
source ros2_ws/install/setup.bash

# 实时查看控制信号
ros2 topic echo /joy
```

**预期输出：**
```
header:
  stamp:
    sec: 1234567890
    nanosec: 123456789
  frame_id: ''
axes: [-0.6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
buttons: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
---
```

## 📊 数据流验证

### 前端 → 机器人端

1. **前端发送**：
   ```
   🔵 [FRONTEND] sending data {axes: [0.6, 0, 0, 0], buttons: [...]} on channel: dataChannel
   ```

2. **机器人端接收**：
   ```
   🔵 [DATA CHANNEL] Received raw message: {"axes":[0.6,0,0,0],...}
   🔵 [DATA CHANNEL] Parsed data: {"axes":[0.6,0,0,0],...}
   🔵 [DATA CHANNEL] No type field, treating as joy message
   ```

3. **ROS发布**：
   ```
   🟢 [JOY MSG] publishJoyMessage called with: ...
   ✅ [JOY MSG] Published a joy message to ROS topic /joy
   ```

## ⚠️ 注意事项

1. **阈值过滤**：如果所有axes和buttons值都低于0.09，消息会被过滤，不会发布到ROS
2. **Axes反转**：机器人端会对 `axes[0]` 和 `axes[1]` 进行反转（乘以-1）
3. **单次按键**：某些按钮（A、B、Home）是单次触发，按下后会自动重置

## 🔧 故障排查

### 问题1：按键盘没有反应

**检查：**
1. 数据通道是否打开？
2. 浏览器console是否有 "sending data" 日志？
3. 机器人端是否有 "Received raw message" 日志？

### 问题2：手柄没有反应

**检查：**
1. 手柄是否被浏览器识别？（查看console是否有 "Gamepad connected"）
2. 手柄是否支持标准Gamepad API？
3. 尝试刷新页面重新连接

### 问题3：ROS没有收到消息

**检查：**
1. 运行 `ros2 topic echo /joy` 查看是否有消息
2. 检查机器人端日志是否有 "Published a joy message"
3. 检查是否有阈值过滤日志

## 📝 测试检查清单

- [ ] 前端数据通道打开
- [ ] 机器人端数据通道打开
- [ ] 键盘输入有反应
- [ ] 手柄输入有反应（如果使用）
- [ ] ROS话题 `/joy` 有消息
- [ ] 机器人实际执行动作





