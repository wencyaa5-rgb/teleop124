# 摄像头自动检测实现说明

## 📋 实现方案

我为你准备了**方案1（自动检测+Fallback）**的完整实现，这是最小改动且最灵活的方案。

---

## 🔧 需要修改的文件

### 1. `teleop/util.py` 
**改动**: 增强`get_camera_config()`函数，添加自动检测功能

**主要改动**:
- 添加`detect_working_cameras()`函数 - 检测可用设备
- 添加`test_device_access()`函数 - 测试设备可用性
- 修改`get_camera_config()`函数 - 添加自动检测和fallback逻辑

**优点**:
- ✅ 向后兼容 - 如果环境变量已设置，优先使用
- ✅ 自动fallback - 配置的设备不可用时自动选择可用设备
- ✅ 详细日志 - 记录检测和选择过程
- ✅ 最小改动 - 只修改一个函数

### 2. `teleop/docker-compose.yml` (可选)
**改动**: 添加更多video设备映射，支持更多设备

**建议修改**:
```yaml
devices:
  - "/dev/video0:/dev/video0"
  - "/dev/video1:/dev/video1"
  - "/dev/video2:/dev/video2"
  - "/dev/video3:/dev/video3"
  - "/dev/video4:/dev/video4"
  - "/dev/video5:/dev/video5"
```

这样容器内可以访问所有video设备，代码可以自动选择。

---

## 🎯 工作原理

### 自动检测流程

1. **启动时检测**
   - 程序启动时，`get_camera_config()`被调用
   - 自动扫描`/dev/video*`设备
   - 使用GStreamer测试每个设备是否可用

2. **设备选择逻辑**
   ```
   如果 CAMERA_PRIMARY_DEVICE 环境变量已设置:
       ├─ 设备存在且可用 → 使用配置的设备 ✅
       ├─ 设备不存在或不可用 → 自动选择第一个可用设备 ⚠️ (记录警告)
       └─ 没有可用设备 → 使用配置的设备（尝试使用）⚠️
   
   如果 CAMERA_PRIMARY_DEVICE 环境变量未设置:
       ├─ 有可用设备 → 自动选择第一个可用设备 ✅
       └─ 没有可用设备 → 使用默认值 /dev/video0 ⚠️
   ```

3. **日志记录**
   - 所有检测和选择过程都会记录日志
   - 方便调试和问题排查

---

## 📝 使用示例

### 场景1: 环境变量已设置，设备可用
```bash
# docker-compose.yml
environment:
  - CAMERA_PRIMARY_DEVICE=/dev/video0
```
**结果**: 使用 `/dev/video0` ✅

### 场景2: 环境变量已设置，设备不可用
```bash
# docker-compose.yml
environment:
  - CAMERA_PRIMARY_DEVICE=/dev/video0  # 但video0不可用
```
**结果**: 自动检测到 `/dev/video2` 可用，自动使用 `/dev/video2` ⚠️ (记录警告)

### 场景3: 环境变量未设置
```bash
# docker-compose.yml
# 不设置 CAMERA_PRIMARY_DEVICE
```
**结果**: 自动检测并选择第一个可用设备（如 `/dev/video2`）✅

### 场景4: 新设备插入
```bash
# 插入新的USB摄像头，系统分配 /dev/video6
# 如果当前使用的设备断开，程序重启时会自动检测到新设备
```
**结果**: 自动检测到 `/dev/video6`，如果配置的设备不可用，自动使用新设备 ✅

---

## ⚠️ 注意事项

1. **性能**: 检测过程在启动时执行一次，不会影响运行时性能
2. **设备稳定性**: 建议优先使用环境变量指定稳定设备，自动检测作为fallback
3. **容器重启**: 如果设备变化，需要重启容器才能检测到新设备
4. **权限**: 确保所有video设备有正确的权限（通常已通过docker-compose配置）

---

## 🚀 实施步骤

如果你同意这个方案，我会：

1. **修改 `teleop/util.py`**
   - 添加自动检测函数
   - 增强`get_camera_config()`函数
   - 保持所有现有功能不变

2. **（可选）修改 `teleop/docker-compose.yml`**
   - 添加更多video设备映射
   - 支持video0-5或更多

3. **测试验证**
   - 确保向后兼容
   - 测试自动检测功能

---

## ❓ 需要你的确认

**请确认**:
1. ✅ 是否允许修改 `teleop/util.py` 添加自动检测功能？
2. ✅ 是否允许修改 `teleop/docker-compose.yml` 添加更多设备映射？

**如果你同意，我会立即实施！**

---

## 📊 预期效果

实施后：
- ✅ 新设备插入后，重启容器即可自动检测和使用
- ✅ 如果配置的设备不可用，自动fallback到可用设备
- ✅ 无需手动修改配置文件
- ✅ 详细的日志记录，方便调试

